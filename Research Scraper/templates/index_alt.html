<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Paper & Patent Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="container mt-5">
  <h1 class="mb-4">Search Papers & Patents</h1>

  <!-- Use an id so we can intercept submit and start SSE -->
  <form id="search-form" action="/search" method="post">
    <div class="row g-4">
      <!-- Paper fields -->
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">Paper Search (optional)</h5>

            <div class="mb-3">
              <input type="text" name="paper_query" class="form-control"
                     placeholder="Enter paper search term (optional)">
            </div>

            <div class="mb-3">
              <label class="form-label">Mode:</label><br>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="mode" id="mode_sections" value="sections">
                <label class="form-check-label" for="mode_sections">Sections</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="mode" id="mode_full" value="full">
                <label class="form-check-label" for="mode_full">Full</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="mode" id="mode_notext" value="notext" checked>
                <label class="form-check-label" for="mode_notext">No Text (default)</label>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Number of paper results (n):</label>
              <input type="number" name="paper_n" class="form-control" value="10" min="1" max="100">
              <small class="form-text text-muted">Leave blank fields to skip paper search.</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Patent fields -->
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">Patent Search (optional)</h5>

            <div class="mb-3">
              <input type="text" name="patent_query" class="form-control"
                     placeholder="Enter patent search term (optional)">
            </div>

            <div class="mb-3">
              <label class="form-label">Number of patent results (n):</label>
              <input type="number" name="patent_n" class="form-control" value="10" min="1" max="100">
              <small class="form-text text-muted">Leave blank fields to skip patent search.</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Intent field (below cards, above submit) -->
    <div class="row g-4 mt-3">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <label for="intent" class="form-label mb-1">Intent (required)</label>
            <textarea id="intent" name="intent" class="form-control" rows="2" required
              placeholder="e.g., Find market fit and propose a founding team; prioritize overlaps between authors and inventors."></textarea>
            <small class="form-text text-muted">Describe what you want the analysis to optimize for.</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Submit -->
    <div class="mt-4">
      <button id="run-btn" type="submit" class="btn btn-primary btn-lg">Search & Analyze</button>
    </div>
  </form>

  <!-- Progress UI -->
  <div id="progress-wrap" class="mt-4" style="display:none;">
    <div class="progress" style="height: 24px;">
      <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
           role="progressbar" style="width: 0%;">0%</div>
    </div>
    <div id="progress-status" class="mt-2 small text-muted">Starting…</div>
  </div>

  <!-- Final results go here -->
  <div id="results" class="mt-4"></div>

  <script>
    (function () {
      const form    = document.getElementById('search-form');
      const runBtn  = document.getElementById('run-btn');
      const wrap    = document.getElementById('progress-wrap');
      const bar     = document.getElementById('progress-bar');
      const status  = document.getElementById('progress-status');
      const results = document.getElementById('results');

      form.addEventListener('submit', function (e) {
        e.preventDefault();

        // Build querystring for SSE (SSE uses GET)
        const fd = new FormData(form);
        const qs = new URLSearchParams(fd).toString();

        // Reset UI
        results.innerHTML = '';
        wrap.style.display = 'block';
        bar.style.width = '0%';
        bar.textContent = '0%';
        bar.classList.remove('bg-danger');
        bar.classList.add('progress-bar-striped', 'progress-bar-animated');
        status.textContent = 'Queued…';
        runBtn.disabled = true;

        // Open SSE stream
        const es = new EventSource(`/analyze_sse?${qs}`);

        es.onmessage = (evt) => {
          try {
            const msg = JSON.parse(evt.data);
            if (msg.type === 'progress') {
              const pct = Math.max(0, Math.min(100, Math.floor(msg.pct)));
              bar.style.width = pct + '%';
              bar.textContent = pct + '%';
              status.textContent = msg.note || 'Working…';
            } else if (msg.type === 'final') {
              results.innerHTML = msg.html || '<p>No output.</p>';
              status.textContent = 'Done.';
              bar.classList.remove('progress-bar-animated');
              es.close();
              runBtn.disabled = false;
            } else if (msg.type === 'error') {
              status.textContent = 'Error: ' + (msg.error || 'unknown');
              bar.classList.remove('progress-bar-animated', 'progress-bar-striped');
              bar.classList.add('bg-danger');
              es.close();
              runBtn.disabled = false;
            }
          } catch (err) {
            console.error('SSE parse error', err);
          }
        };

        es.onerror = () => {
          status.textContent = 'Connection lost.';
          bar.classList.remove('progress-bar-animated', 'progress-bar-striped');
          bar.classList.add('bg-danger');
          es.close();
          runBtn.disabled = false;
        };
      });
    })();
  </script>
</body>
</html>
